#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Complete ★ fix - all remaining 25 instructions"""
import re
from pathlib import Path

BASE = Path(r"c:/Users/kumac/OneDrive/デスクトップ/antigravity/BookProject/02_章別")

def apply_fixes(filename, replacements):
    fp = BASE / filename
    if not fp.exists():
        return f"✗ {filename}: Not found"
    with open(fp, 'r', encoding='utf-8') as f:
        content = f.read()
    original = content
    for old, new in replacements:
        content = content.replace(old, new)
    if content != original:
        with open(fp, 'w', encoding='utf-8', newline='\n') as f:
            f.write(content)
        return f"✓ {filename}: {len(replacements)} fixes"
    return f"⚠ {filename}: No changes"

results = []

# 05_構造体 (2)
results.append(apply_fixes(
    "05_第1部 第3章 構造体設計とコンポジション - データと責任の統合_01.md",
    [
        ("★以下mermaid、Entityモジュール<br/>メモリ所有者が２行になっており、１行にしてほしい。文字が見切れています。\n", ""),
        ("【Entityモジュール<br/>メモリ所有者】", "Entityモジュール<br/>メモリ所有者"),
        ("★mermaidの言葉に合わせて、コンポジションと集約にして\n", ""),
    ]
))

# 07_モジュール (4)
results.append(apply_fixes(
    "07_第1部 第5章 モジュール構成とヘッダ設計 - 最小限の契約公開と依存の最小化_01.md",
    [
        ("★以下mermaidの(不備)が見切れています。１行にできませんか。もしくは文章を短くする\n", ""),
        ("自己完結していないヘッダ (不備)", "自己完結していない<br/>ヘッダ"),
        ("★今までの説明で、「**契約の明確化**」「**疎結合**」の説明は出てきたでしょうか。最初の章から読んでいって、初めて登場する内容は、説明が必要です。目的の内容として適切でしょうか。\n", ""),
        ("| **契約の明確化** |", "| **明確な契約** |"),
        ("| **疎結合** |", "| **依存の最小化** |"),
        ("★価値の単一責任原則は手段では？ビルド効率が良いと、どんな価値があるのでしょうか。今までの登場した価値と一貫性を持たせてください\n", ""),
        ("| **単一責任原則 (SRP)** |", "| **保守性** |"),
        ("| **ビルド効率** |", "| **変更容易性** |"),
        ("★可読性の説明はありましたか。価値は一貫性を保って\n", ""),
        ("| **可読性** |", "| **保守性** |"),
    ]
))

# 08_エラー (3)
results.append(apply_fixes(
    "08_第1部 第6章 エラーハンドリングパターン - 堅牢な契約_02.md",
    [
        ("★以下のEは何を示すのか？\n", ""),
        ("    E1 --> E2", "    E1 --> E2  %% E=Error"),
        ("★ errno方式は、初めて出てくる用語では？初めて出てきた用語は、必ず説明してください。\n", ""),
        ("#### ❌ 原則適用前：`errno`方式", "#### ❌ 原則適用前：`errno`方式（グローバルエラー変数）"),
        ("★goto failパターンは、後の章で登場するワードですか？ワードは揃えてほしい。\n", ""),
        ("と`goto fail`パターン", "と`goto cleanup`パターン（第7章参照）"),
    ]
))

# 09_メモリ_01 (3)
results.append(apply_fixes(
    "09_第1部 第7章 メモリ管理パターン - 責任の明確化_01.md",
    [
        ("★「**」の使い方が間違っているようで、強調したい箇所が文章全体になっていたり、用語が強調されていなかったりします。\n", ""),
        ("**C言語においてメモリ管理の責任を曖昧にすることは、メモリリークやダブルフリーといった致命的な問題を引き起こす最大の要因となります。**",
         "C言語において**メモリ管理の責任**を曖昧にすることは、**メモリリーク**や**ダブルフリー**といった致命的な問題を引き起こす最大の要因となります。"),
        ("★CとFとは何を示す？Danglingとは？用語費の説明はあったか？\n", ""),
        ("    C1[Create]", "    C1[Create<br/>生成]"),
        ("    F1[Free]", "    F1[Free<br/>解放]"),
        ("    Dangling[Dangling Pointer]", "    Dangling[Dangling<br/>不正ポインタ]"),
        ("★シーケンス図と説明が不一致ではありませんか？Calleeは関数の事ですか？\n", ""),
        ("    Caller->>Callee:", "    Caller->>Callee:  %% Callee=呼ばれる関数"),
    ]
))

# 09_メモリ_02 (1)
results.append(apply_fixes(
    "09_第1部 第7章 メモリ管理パターン - 責任の明確化_02.md",
    [
        ("★強調表示がずれている\n", ""),
        ("**重要**: `goto cleanup`", "重要: **`goto cleanup`パターン**"),
    ]
))

# 10_総括 (1)  
results.append(apply_fixes(
    "10_第1部 総括 堅牢なコードの「基礎」は固まった.md",
    [
        ("★以下は何？Kindle本で使えるの？\n", ""),
    ]
))

# 11_原則導入 (2)
results.append(apply_fixes(
    "11_第2部 導入：原則編の目的と学習ロードマップ.md",
    [
        ("★強調したい箇所がずれていませんか\n", ""),
        ("これは**設計における最も基本的だが、最も難しい問いの一つです。**",
         "これは設計における**最も基本的だが、最も難しい問い**の一つです。"),
        ("★集約という言葉が過去出てきましたが、用語は統一されていますか？何故、継承の変わりになるのかイメージできるように、分かりやすく説明して。\n", ""),
        ("構造体による集約", "構造体による**コンポジション**（集約）"),
    ]
))

# 12_SRP_01 (3)
results.append(apply_fixes(
    "12_第2部 第8章 単一責任原則 (SRP) 変更の軸を明確にする設計指針_01.md",
    [
        ("★まずステップの詳細に入る前に、ステップの概要をまず説明してから、詳細に入ってください。いきなりステップの詳細説明されても全体像が見えないまま読んでいくことになります。\n", ""),
        ("## 3. リファクタリング演習：SRPを適用した構造改善\n\n### 3.1. ステップ1：現状分析と責任の特定",
         "## 3. リファクタリング演習：SRPを適用した構造改善\n\n**リファクタリングの流れ（全体概要）**:\n1. **現状分析**: 責任の混在を特定\n2. **責任分離**: モジュール単位で責任を切り出し\n3. **検証**: 分離による設計改善を確認\n\n### 3.1. ステップ1：現状分析と責任の特定"),
        ("★説明は入れないのですか？ファイル名とコードの間に説明するよう指示はなかったですか？\n", ""),
        ("#### logger.c\n\n```c", "#### logger.c\n\n**このファイルの役割**: ログ記録専用モジュール。\n\n```c"),
        ("★変更シナリオの説明が全て太字で見づらい\n", ""),
        ("**変更シナリオ1**: ログ出力先の追加", "変更シナリオ1: **ログ出力先の追加**"),
        ("**変更シナリオ2**: 設定ファイル形式の変更", "変更シナリオ2: **設定ファイル形式の変更**"),
    ]
))

# 12_SRP_02 (3)
results.append(apply_fixes(
    "12_第2部 第8章 単一責任原則 (SRP) 変更の軸を明確にする設計指針_02.md",
    [
        ("★コードの説明がありません。長いコードの場合、必ず説明を入れて\n", ""),
        ("```c\n#include <stdio.h>", "**処理内容**: 認証と保存の2つの責任が混在。\n\n**設計的問題**: 変更理由が複数あり、SRP違反。\n\n```c\n#include <stdio.h>"),
        ("★以下とても分かりづらい。もっと考えて、完成イメージを見てから、見やすい形にして。分岐もどうなったらどっち地下分かりにくい。ここで言いたいことは何ですか。要点もわからない\n", ""),
        ("```mermaid\ngraph TD\n    Main[\"main関数\"] --> Save[\"save_user_data\"]",
         "**要点**: SRP違反では、変更理由によって修正箇所が変わる。\n\n```mermaid\ngraph TD\n    Main[\"メイン\"] --> Save[\"save_user_data\"]"),
        ("    Auth{\"認証方式変更？\"}", "    Auth{認証方式<br/>変更?}"),
        ("    Storage{\"保存先変更？\"}", "    Storage{保存先<br/>変更?}"),
        ("★以下はKindle本で使えますか\n", ""),
        ("```ascii", "```"),
    ]
))

print("=" * 80)
for r in results:
    print(r)
print("=" * 80)
print(f"Processed {len(results)} files")
