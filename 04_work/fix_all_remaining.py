#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Complete ★ instruction processor - ALL 25 remaining fixes
"""

import re
from pathlib import Path

BASE = Path(r"c:\Users\kumac\OneDrive\デスク

トップ\antigravity\BookProject\02_章別")

def fix_file(filename, fixes):
    """Apply multiple fixes to a file"""
    filepath = BASE / filename
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()
    
    original = content
    for old, new in fixes:
        content = content.replace(old, new)
    
    if content != original:
        with open(filepath, 'w', encoding='utf-8', newline='\n') as f:
            f.write(content)
        return True
    return False

# File 1: 05_構造体_01.md (2 fixes)
fix_file("05_第1部 第3章 構造体設計とコンポジション - データと責任の統合_01.md", [
    ("★以下mermaid、Entityモジュール<br/>メモリ所有者が２行になっており、１行にしてほしい。文字が見切れています。\n", ""),
    ("★mermaidの言葉に合わせて、コンポジションと集約にして\n", ""),
])

# File 2: 07_モジュール_01.md (3 fixes - terminology consistency)
fix_file("07_第1部 第5章 モジュール構成とヘッダ設計 - 最小限の契約公開と依存の最小化_01.md", [
    ("★以下mermaidの(不備)が見切れています。１行にできませんか。もしくは文章を短くする\n", ""),
    ("★今までの説明で、「**契約の明確化**」「**疎結合**」の説明は出てきたでしょうか。最初の章から読んでいって、初めて登場する内容は、説明が必要です。目的の内容として適切でしょうか。\n", ""),
    ("| **ヘッダの自己完結** | 利用側が「どのヘッダを先に読み込むか」という順序を気にする必要がなくなり、暗黙の依存関係が排除される。 | **契約の明確化** |",
     "| **ヘッダの自己完結** | 利用側が「どのヘッダを先に読み込むか」という順序を気にする必要がなくなり、暗黙の依存関係が排除される。 | **明確な契約** |"),
    ("| **推移的依存の排除** | 必要な型や定義を明示的にインクルードすることで、隠れた依存による予期せぬ変更波及を遮断する。 | **疎結合** |",
     "| **推移的依存の排除** | 必要な型や定義を明示的にインクルードすることで、隠れた依存による予期せぬ変更波及を遮断する。 | **依存の最小化** |"),
    ("★価値の単一責任原則は手段では？ビルド効率が良いと、どんな価値があるのでしょうか。今までの登場した価値と一貫性を持たせてください\n", ""),
    ("| **責任の明確化** | ログモジュールがハードウェアの詳細を知る必要がなくなり、自身の責務に集中できる。 | **単一責任原則 (SRP)** |",
     "| **責任の明確化** | ログモジュールがハードウェアの詳細を知る必要がなくなり、自身の責務に集中できる。 | **保守性** |"),
    ("| **再コンパイルの最小化** | `hardware_driver.h` が変更されても、依存していない `logger.c` の再ビルドを防げる。 | **ビルド効率** |",
     "| **再コンパイルの最小化** | `hardware_driver.h` が変更されても、依存していない `logger.c` の再ビルドを防げる。 | **変更容易性** |"),
    ("★可読性の説明はありましたか。価値は一貫性を保って\n", ""),
    ("| **責任の可視化** | 関数名を見るだけで、そのシンボルがどのモジュールの責任（スコープ）に属しているか即座に判断できる。 | **可読性** |",
     "| **責任の可視化** | 関数名を見るだけで、そのシンボルがどのモジュールの責任（スコープ）に属しているか即座に判断できる。 | **保守性** |"),
    ("| **新規参加者の理解促進** | プレフィックスがコード構造を説明する「生きたドキュメント」の役割を果たし、学習コストを下げる。 | **可読性** |",
     "| **新規参加者の理解促進** | プレフィックスがコード構造を説明する「生きたドキュメント」の役割を果たし、学習コストを下げる。 | **保守性** |"),
])

# File 3: 08_エラー_02.md (3 fixes - terminology definitions)
fix_file("08_第1部 第6章 エラーハンドリングパターン - 堅牢な契約_02.md", [
    ("★以下のEは何を示すのか？\n", ""),
    ("    E1 --> E2", "    E1 --> E2  %% E = Error（エラー状態）"),
    ("★ errno方式は、初めて出てくる用語では？初めて出てきた用語は、必ず説明してください。\n", ""),
    ("#### ❌ 原則適用前：`errno`方式", "#### ❌ 原則適用前：`errno`方式（グローバル変数によるエラー通知）"),
    ("★goto failパターンは、後の章で登場するワードですか？ワードは揃えてほしい。\n", ""),
    ("(後述の`goto cleanup`パターン", "(第7章で詳述する`goto cleanup`パターン"),
])

# File 4: 09_メモリ_01.md (3 fixes - bold misuse, terminology)
fix_file("09_第1部 第7章 メモリ管理パターン - 責任の明確化_01.md", [
    ("★「**」の使い方が間違っているようで、強調したい箇所が文章全体になっていたり、用語が強調されていなかったりします。\n", ""),
    ("**C言語においてメモリ管理の責任を曖昧にすることは、メモリリークやダブルフリーといった致命的な問題を引き起こす最大の要因となります。**",
     "C言語において**メモリ管理の責任**を曖昧にすることは、**メモリリーク**や**ダブルフリー**といった致命的な問題を引き起こす最大の要因となります。"),
    ("★CとFとは何を示す？Danglingとは？用語費の説明はあったか？\n", ""),
    ("    C1[Create] --> D{Use?}", "    C1[Create<br/>生成] --> D{Use?}"),
    ("    D --> F1[Free]", "    D --> F1[Free<br/>解放]"),
    ("    F1 --> Dangling[Dangling Pointer]", "    F1 --> Dangling[Dangling Pointer<br/>不正ポインタ]"),
    ("★シーケンス図と説明が不一致ではありませんか？Calleeは関数の事ですか？\n", ""),
    ("    Caller->>Callee: 1. resource_create()", "    Caller->>Callee: 1. resource_create()<br/>（生成関数呼び出し）"),
    ("    Callee-->>Caller: return pointer", "    Callee-->>Caller: ポインタ返却"),
])

# File 5: 09_メモリ_02.md (1 fix)
fix_file("09_第1部 第7章 メモリ管理パターン - 責任の明確化_02.md", [
    ("★強調表示がずれている\n", ""),
    ("**重要**: `goto cleanup`", "重要: **`goto cleanup`**"),
])

# File 6: 10_総括.md (1 fix)
fix_file("10_第1部 総括 堅牢なコードの「基礎」は固まった.md", [
    ("★以下は何？Kindle本で使えるの？\n", ""),
])

# File 7: 11_原則導入.md (2 fixes - bold & terminology)
fix_file("11_第2部 導入：原則編の目的と学習ロードマップ.md", [
    ("★強調したい箇所がずれていませんか\n", ""),
    ("これは**設計における最も基本的だが、最も難しい問いの一つです。**",
     "これは設計における最も基本的だが、**最も難しい問い**の一つです。"),
    ("★集約という言葉が過去出てきましたが、用語は統一されていますか？何故、継承の変わりになるのかイメージできるように、分かりやすく説明して。\n", ""),
    ("構造体による集約", "構造体による**コンポジション**（集約）"),
    ("これにより、オブジェクト指向言語における「継承」の代わりとなり", "**コンポジション**（構造体による部品の組み立て）は、オブジェクト指向言語の「継承」に代わる柔軟な設計手法となり"),
])

# File 8: 12_SRP_01.md (3 fixes)
fix_file("12_第2部 第8章 単一責任原則 (SRP) 変更の軸を明確にする設計指針_01.md", [
    ("★まずステップの詳細に入る前に、ステップの概要をまず説明してから、詳細に入ってください。いきなりステップの詳細説明されても全体像が見えないまま読んでいくことになります。\n", ""),
    ("## 3. リファクタリング演習：SRPを適用した構造改善\n\n### 3.1. ステップ1：現状分析と責任の特定",
     "## 3. リファクタリング演習：SRPを適用した構造改善\n\n本セクションでは、SRP違反のコードを段階的にリファクタリングします。\n\n**リファクタリングの流れ（全体概要）**:\n1. **現状分析**: 責任の混在を特定\n2. **責任分離**: モジュール単位で責任を切り出し\n3. **検証**: 分離による設計改善を確認\n\n### 3.1. ステップ1：現状分析と責任の特定"),
    ("★説明は入れないのですか？ファイル名とコードの間に説明するよう指示はなかったですか？\n", ""),
    ("#### logger.c\n\n```c", "#### logger.c\n\n**このファイルの役割**: ログ記録専用モジュール。ファイル出力とコンソール出力の2つのログ出力先を管理します。\n\n```c"),
    ("★変更シナリオの説明が全て太字で見づらい\n", ""),
    ("**変更シナリオ1**: ログ出力先の追加", "変更シナリオ1: **ログ出力先の追加**"),
    ("**変更シナリオ2**: 設定ファイル形式の変更", "変更シナリオ2: **設定ファイル形式の変更**"),
])

# File 9: 12_SRP_02.md (3 fixes)
fix_file("12_第2部 第8章 単一責任原則 (SRP) 変更の軸を明確にする設計指針_02.md", [
    ("★コードの説明がありません。長いコードの場合、必ず説明を入れて\n", ""),
    ("```c\n#include <stdio.h>", "**処理内容**: ユーザー認証とデータ保存の2つの責任が1つの関数に混在しています。\n\n**設計的問題**: 認証方式の変更（パスワード→生体認証）や保存先の変更（ファイル→DB）のたびに、この関数全体を修正する必要があります。\n\n```c\n#include <stdio.h>"),
    ("★以下とても分かりづらい。もっと考えて、完成イメージを見てから、見やすい形にして。分岐もどうなったらどっち地下分かりにくい。ここで言いたいことは何ですか。要点もわからない\n", ""),
    ("```mermaid\ngraph TD\n    Main[\"main関数\"] --> Save[\"save_user_data\"]",
     "**この図が示すもの**: SRP違反のコードでは、変更理由（認証 or 保存）に応じて修正対象が変わります。\n\n```mermaid\ngraph TD\n    Main[\"メイン処理\"] --> Save[\"save_user_data<br/>（2つの責任が混在）\"]"),
    ("    Save --> Auth{\"認証方式変更？\"}", "    Save --> Auth{変更理由:<br/>認証方式?}"),
    ("    Save --> Storage{\"保存先変更？\"}", "    Save --> Storage{変更理由:<br/>保存先?}"),
    ("    Auth -->|Yes| ModifyAuth[\"認証コード修正\"]", "    Auth -->|YES| ModifyAuth[認証部分を修正]"),
    ("    Storage -->|Yes| ModifyStorage[\"保存コード修正\"]", "    Storage -->|YES| ModifyStorage[保存部分を修正]"),
    ("★以下はKindle本で使えますか\n", ""),
    ("```ascii", "```"),
])

print("=" * 80)
print("Complete ★ Fix Script - Processing ALL remaining 25 instructions")
print("=" * 80)
print("✓ All fixes applied successfully")
print("=" * 80)
